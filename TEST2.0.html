<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>音频前测实验</title>
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions"></script>
  <script src="https://unpkg.com/@jspsych/plugin-audio-button-response"></script>
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" />
  <style>
    .jspsych-btn {
      margin: 5px;
      padding: 8px 16px;
      cursor: pointer;
    }
    #replay-btn {
      margin: 15px 0;
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #replay-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .instructions {
      line-height: 1.6;
      margin-bottom: 20px;
    }
    .question-container {
      margin-bottom: 20px;
    }
  </style>
</head>
<body></body>
<script>
const jsPsych = initJsPsych({
  on_finish: function() {
    const data = jsPsych.data.get();
    // 添加实验元数据
    data.addProperties({
      experiment_start: new Date(jsPsych.data.get().values()[0]?.time_start || Date.now()).toISOString(),
      experiment_end: new Date().toISOString(),
      duration_seconds: (jsPsych.totalTime() / 1000).toFixed(2)
    });
    data.localSave('csv','results.csv');
  }
});

// =========================
// 1. 被试信息
// =========================
let info_form = {
  type: jsPsychSurveyHtmlForm,
  preamble: "<h2>被试信息</h2><p>请填写以下信息：</p>",
  html: `
    姓名: <input name="name" type="text" required><br>
    性别: <select name="gender" required>
            <option value="">请选择</option>
            <option value="男">男</option>
            <option value="女">女</option>
          </select><br>
    联系方式: <input name="contact" type="text" required><br>
  `,
  button_label: "继续"
};

// =========================
// 2. 指导语
// =========================
let instructions = {
  type: jsPsychInstructions,
  pages: [
    `<div class="instructions">
      <h2>指导语</h2>
      <p>您将听到一系列音频。每个音频需要先点击按钮开始播放，并且必须完整听完一次，然后回答问题。</p>
      <p>答题页面可以点击"再听一次"按钮回放音频。</p>
      <p>请根据您的真实感受作答，答案没有对错之分。</p>
    </div>`
  ],
  show_clickable_nav: true,
  button_label_next: "开始练习",
  button_label_previous: "重新阅读"
};

// =========================
// 3. 加载 CSV 并处理错误
// =========================
async function loadMaterials(){
  try {
    let response = await fetch("https://gigibon.github.io/Warn_name_audio/materials.csv"); // 修改为你的 CSV 公网 URL
    
    if(!response.ok) {
      throw new Error(`HTTP错误: ${response.status}`);
    }
    
    let text = await response.text();
    
    // 处理CSV
    let rows = text.trim().split("\n").map(r => r.split(","));
    if(rows.length <= 1) {
      throw new Error("CSV文件格式错误或内容为空");
    }
    
    let header = rows[0];
    let data = rows.slice(1).map(r => {
      let obj = {};
      header.forEach((h, i) => obj[h] = r[i] || "");
      return obj;
    });
    
    // 验证数据格式
    const requiredFields = ['audio', 'type', 'q1', 'q2', 'q3', 'q4', 'q5'];
    data.forEach((row, index) => {
      requiredFields.forEach(field => {
        if(!row[field]) {
          throw new Error(`CSV数据不完整，第${index+2}行缺少${field}字段`);
        }
      });
    });

    // 断点续做处理
    let completed = JSON.parse(localStorage.getItem("completedTrials") || "[]");
    const remaining = data.filter(row => !completed.includes(row.audio));
    
    if(remaining.length < data.length) {
      console.log(`检测到已完成${data.length - remaining.length}个试次，将继续剩余部分`);
    }
    
    return remaining;
    
  } catch (error) {
    console.error("材料加载错误:", error);
    // 显示友好的错误提示
    const errorTrial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<h2>实验无法启动</h2>
                 <p>错误信息: ${error.message}</p>
                 <p>请联系管理员解决此问题。</p>`,
      choices: ["关闭页面"]
    };
    jsPsych.run([errorTrial]);
    throw error; // 终止后续执行
  }
}

// =========================
// 4. 创建单条试次（优化版）
// =========================
function createTrial(row){
  // 音频播放验证函数
  const validateAudioPlayback = async (audioUrl) => {
    try {
      const audio = new Audio(audioUrl);
      const promise = audio.play();
      // 如果浏览器需要用户交互，play()会返回一个pending状态的promise
      if (promise !== undefined) {
        await promise;
      }
      audio.pause();
      return true;
    } catch (error) {
      console.error("音频验证失败:", error);
      return false;
    }
  };

  return [
    {
      type: jsPsychAudioButtonResponse,
      stimulus: row.audio,
      choices: ["开始播放音频"], // 强制用户交互以符合自动播放政策
      trial_ends_after_audio: true,
      prompt: "<p>请点击按钮开始播放音频（请完整听完）</p>",
      on_load: async function() {
        // 预加载并验证音频
        const isValid = await validateAudioPlayback(row.audio);
        if (!isValid) {
          alert("音频文件无法播放，请检查网络连接或联系管理员");
        }
      },
      on_error: function(error) {
        console.error("音频播放错误:", error);
        alert("音频播放出现问题，请重试或联系管理员");
      }
    },
    {
      type: jsPsychSurveyMultiChoice,
      preamble: `
        <button id="replay-btn">🔊 再听一次</button>
        <p>请回答以下问题：</p>
      `,
      questions: [
        // 二项选择题
        {prompt: row.q1, name: 'Q1', options: ['陈述语气','警告语气'], required: true},

        // 7点量表题，横向显示，显示两端含义
        {
          prompt: row.q2,
          name: 'Q2',
          options: ['1','2','3','4','5','6','7'],
          required: true,
          horizontal: true,
          prompt_html: `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
              <span>1 = 非常不适合</span>
              <span>7 = 非常适合</span>
            </div>
            ${row.q2}
          `
        },
        {
          prompt: row.q3,
          name: 'Q3',
          options: ['1','2','3','4','5','6','7'],
          required: true,
          horizontal: true,
          prompt_html: `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
              <span>1 = 非常不愉快</span>
              <span>7 = 非常愉快</span>
            </div>
            ${row.q3}
          `
        },
        {
          prompt: row.q4,
          name: 'Q4',
          options: ['1','2','3','4','5','6','7'],
          required: true,
          horizontal: true,
          prompt_html: `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
              <span>1 = 非常平静</span>
              <span>7 = 非常激动</span>
            </div>
            ${row.q4}
          `
        },
        {
          prompt: row.q5,
          name: 'Q5',
          options: ['1','2','3','4','5','6','7'],
          required: true,
          horizontal: true,
          prompt_html: `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
              <span>1 = 完全没有掌控感</span>
              <span>7 = 非常有掌控感</span>
            </div>
            ${row.q5}
          `
        }
      ],
      on_load: function() {
        // 使用事件监听器替代内联脚本，避免DOM冲突
        const replayBtn = document.getElementById("replay-btn");
        replayBtn.addEventListener('click', () => {
          const audio = new Audio(row.audio);
          // 处理播放错误
          audio.play().catch(e => {
            alert("播放失败，请确保已完成首次音频播放");
            console.error("音频重播错误:", e);
          });
        });
      },
      on_finish: function(data){
        data.phase = row.type; // 保存 phase 信息
        data.audio_filename = row.audio.split('/').pop(); // 保存音频文件名
        // 更新已完成试次
        let completed = JSON.parse(localStorage.getItem("completedTrials") || "[]");
        if(!completed.includes(row.audio)){
          completed.push(row.audio);
          localStorage.setItem("completedTrials", JSON.stringify(completed));
        }
      }
    }
  ];
}

// =========================
// 5. 创建练习时间线
// =========================
function createPracticeTimeline(materials){
  let practice = materials.filter(m => m.type === "practice");
  let timeline = [];
  
  if(practice.length === 0) {
    console.warn("未找到练习试次");
    return timeline;
  }
  
  practice.forEach(row => timeline.push(...createTrial(row)));

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p>练习结束。请选择操作：</p>",
    choices: ["重新练习","进入正式实验"],
    button_html: '<button class="jspsych-btn">%choice%</button>',
    on_finish: function(data){
      if(data.response == 0){
        // 重新练习时清除已完成的练习试次记录
        let completed = JSON.parse(localStorage.getItem("completedTrials") || "[]");
        completed = completed.filter(item => !practice.some(p => p.audio === item));
        localStorage.setItem("completedTrials", JSON.stringify(completed));
        
        jsPsych.addNodeToEndOfTimeline(createPracticeTimeline(materials));
      }
    }
  });
  return timeline;
}

// =========================
// 6. 创建正式实验时间线
// =========================
function createFormalTimeline(materials){
  let formal = materials.filter(m => m.type === "formal");
  
  if(formal.length === 0) {
    return [{
      type: jsPsychHtmlButtonResponse,
      stimulus: "<h2>警告</h2><p>未找到正式实验试次</p>",
      choices: ["返回"]
    }];
  }
  
  // 随机排序正式实验试次
  let shuffledFormal = jsPsych.randomization.shuffle(formal);
  let timeline = [];
  
  shuffledFormal.forEach(row => timeline.push(...createTrial(row)));
  
  // 添加实验结束页面
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `<h2>实验结束！</h2>
               <p>感谢您完成所有实验内容。</p>
               <p>您的实验数据已自动下载为CSV文件。</p>
               <p>如果您需要重新进行实验，可以刷新页面并选择"从头开始"。</p>`,
    choices: ["完成并关闭"],
    button_html: '<button class="jspsych-btn">%choice%</button>',
    on_finish: function() {
      // 实验完成后可选清除本地存储
      // localStorage.removeItem("completedTrials");
    }
  });
  
  return timeline;
}

// =========================
// 7. 启动实验（优化版）
// =========================
async function startExperiment(){
  try {
    // 检查是否有历史记录并询问用户
    let completed = JSON.parse(localStorage.getItem("completedTrials") || "[]");
    if(completed.length > 0) {
      // 修改提示逻辑：确定=继续上次进度，取消=重新开始
      const continueProgress = confirm(`检测到您有未完成的实验进度。\n\n是否继续上次的进度？\n- 选择"确定"将继续之前的实验\n- 选择"取消"将清除记录并从头开始`);
      
      if(!continueProgress) { // 用户选择取消，即重新开始
        localStorage.removeItem("completedTrials");
        completed = [];
      }
      // 如果用户选择确定，则保持现有记录不变，继续进度
    }

    let timeline = [];
    timeline.push(info_form);
    timeline.push(instructions);

    let materials = await loadMaterials();
    
    if(materials.length === 0) {
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: "<h2>实验已完成</h2><p>您已完成所有实验内容，感谢参与！</p>",
        choices: ["关闭页面"]
      });
    } else {
      // 加入练习
      timeline = timeline.concat(createPracticeTimeline(materials));
      // 加入正式实验
      timeline = timeline.concat(createFormalTimeline(materials));
    }

    jsPsych.run(timeline);
  } catch (error) {
    console.error("实验启动失败:", error);
  }
}

// 启动实验
startExperiment();
</script>
</html>
