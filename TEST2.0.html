<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>éŸ³é¢‘å‰æµ‹å®éªŒ</title>
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions"></script>
  <script src="https://unpkg.com/@jspsych/plugin-audio-button-response"></script>
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" />
  <style>
    .jspsych-btn {
      margin: 5px;
      padding: 8px 16px;
      cursor: pointer;
    }
    #replay-btn {
      margin: 15px 0;
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #replay-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .instructions {
      line-height: 1.6;
      margin-bottom: 20px;
    }
    .question-container {
      margin-bottom: 20px;
    }
  </style>
</head>
<body></body>
<script>
const jsPsych = initJsPsych({
  on_finish: function() {
    const data = jsPsych.data.get();
    // æ·»åŠ å®éªŒå…ƒæ•°æ®
    data.addProperties({
      experiment_start: new Date(jsPsych.data.get().values()[0]?.time_start || Date.now()).toISOString(),
      experiment_end: new Date().toISOString(),
      duration_seconds: (jsPsych.totalTime() / 1000).toFixed(2)
    });
    data.localSave('csv','results.csv');
  }
});

// =========================
// 1. è¢«è¯•ä¿¡æ¯
// =========================
let info_form = {
  type: jsPsychSurveyHtmlForm,
  preamble: "<h2>è¢«è¯•ä¿¡æ¯</h2><p>è¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š</p>",
  html: `
    å§“å: <input name="name" type="text" required><br>
    æ€§åˆ«: <select name="gender" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="ç”·">ç”·</option>
            <option value="å¥³">å¥³</option>
          </select><br>
    è”ç³»æ–¹å¼: <input name="contact" type="text" required><br>
  `,
  button_label: "ç»§ç»­"
};

// =========================
// 2. æŒ‡å¯¼è¯­
// =========================
let instructions = {
  type: jsPsychInstructions,
  pages: [
    `<div class="instructions">
      <h2>æŒ‡å¯¼è¯­</h2>
      <p>æ‚¨å°†å¬åˆ°ä¸€ç³»åˆ—éŸ³é¢‘ã€‚æ¯ä¸ªéŸ³é¢‘éœ€è¦å…ˆç‚¹å‡»æŒ‰é’®å¼€å§‹æ’­æ”¾ï¼Œå¹¶ä¸”å¿…é¡»å®Œæ•´å¬å®Œä¸€æ¬¡ï¼Œç„¶åå›ç­”é—®é¢˜ã€‚</p>
      <p>ç­”é¢˜é¡µé¢å¯ä»¥ç‚¹å‡»"å†å¬ä¸€æ¬¡"æŒ‰é’®å›æ”¾éŸ³é¢‘ã€‚</p>
      <p>è¯·æ ¹æ®æ‚¨çš„çœŸå®æ„Ÿå—ä½œç­”ï¼Œç­”æ¡ˆæ²¡æœ‰å¯¹é”™ä¹‹åˆ†ã€‚</p>
    </div>`
  ],
  show_clickable_nav: true,
  button_label_next: "å¼€å§‹ç»ƒä¹ ",
  button_label_previous: "é‡æ–°é˜…è¯»"
};

// =========================
// 3. åŠ è½½ CSV å¹¶å¤„ç†é”™è¯¯
// =========================
async function loadMaterials(){
  try {
    let response = await fetch("https://gigibon.github.io/Warn_name_audio/materials.csv"); // ä¿®æ”¹ä¸ºä½ çš„ CSV å…¬ç½‘ URL
    
    if(!response.ok) {
      throw new Error(`HTTPé”™è¯¯: ${response.status}`);
    }
    
    let text = await response.text();
    
    // å¤„ç†CSV
    let rows = text.trim().split("\n").map(r => r.split(","));
    if(rows.length <= 1) {
      throw new Error("CSVæ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–å†…å®¹ä¸ºç©º");
    }
    
    let header = rows[0];
    let data = rows.slice(1).map(r => {
      let obj = {};
      header.forEach((h, i) => obj[h] = r[i] || "");
      return obj;
    });
    
    // éªŒè¯æ•°æ®æ ¼å¼
    const requiredFields = ['audio', 'type', 'q1', 'q2', 'q3', 'q4', 'q5'];
    data.forEach((row, index) => {
      requiredFields.forEach(field => {
        if(!row[field]) {
          throw new Error(`CSVæ•°æ®ä¸å®Œæ•´ï¼Œç¬¬${index+2}è¡Œç¼ºå°‘${field}å­—æ®µ`);
        }
      });
    });

    // æ–­ç‚¹ç»­åšå¤„ç†
    let completed = JSON.parse(localStorage.getItem("completedTrials") || "[]");
    const remaining = data.filter(row => !completed.includes(row.audio));
    
    if(remaining.length < data.length) {
      console.log(`æ£€æµ‹åˆ°å·²å®Œæˆ${data.length - remaining.length}ä¸ªè¯•æ¬¡ï¼Œå°†ç»§ç»­å‰©ä½™éƒ¨åˆ†`);
    }
    
    return remaining;
    
  } catch (error) {
    console.error("ææ–™åŠ è½½é”™è¯¯:", error);
    // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
    const errorTrial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<h2>å®éªŒæ— æ³•å¯åŠ¨</h2>
                 <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                 <p>è¯·è”ç³»ç®¡ç†å‘˜è§£å†³æ­¤é—®é¢˜ã€‚</p>`,
      choices: ["å…³é—­é¡µé¢"]
    };
    jsPsych.run([errorTrial]);
    throw error; // ç»ˆæ­¢åç»­æ‰§è¡Œ
  }
}

// =========================
// 4. åˆ›å»ºå•æ¡è¯•æ¬¡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
// =========================
function createTrial(row){
  // éŸ³é¢‘æ’­æ”¾éªŒè¯å‡½æ•°
  const validateAudioPlayback = async (audioUrl) => {
    try {
      const audio = new Audio(audioUrl);
      const promise = audio.play();
      // å¦‚æœæµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’ï¼Œplay()ä¼šè¿”å›ä¸€ä¸ªpendingçŠ¶æ€çš„promise
      if (promise !== undefined) {
        await promise;
      }
      audio.pause();
      return true;
    } catch (error) {
      console.error("éŸ³é¢‘éªŒè¯å¤±è´¥:", error);
      return false;
    }
  };

  return [
    {
      type: jsPsychAudioButtonResponse,
      stimulus: row.audio,
      choices: ["å¼€å§‹æ’­æ”¾éŸ³é¢‘"], // å¼ºåˆ¶ç”¨æˆ·äº¤äº’ä»¥ç¬¦åˆè‡ªåŠ¨æ’­æ”¾æ”¿ç­–
      trial_ends_after_audio: true,
      prompt: "<p>è¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹æ’­æ”¾éŸ³é¢‘ï¼ˆè¯·å®Œæ•´å¬å®Œï¼‰</p>",
      on_load: async function() {
        // é¢„åŠ è½½å¹¶éªŒè¯éŸ³é¢‘
        const isValid = await validateAudioPlayback(row.audio);
        if (!isValid) {
          alert("éŸ³é¢‘æ–‡ä»¶æ— æ³•æ’­æ”¾ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜");
        }
      },
      on_error: function(error) {
        console.error("éŸ³é¢‘æ’­æ”¾é”™è¯¯:", error);
        alert("éŸ³é¢‘æ’­æ”¾å‡ºç°é—®é¢˜ï¼Œè¯·é‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜");
      }
    },
    {
      type: jsPsychSurveyMultiChoice,
      preamble: `
        <button id="replay-btn">ğŸ”Š å†å¬ä¸€æ¬¡</button>
        <p>è¯·å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š</p>
      `,
      questions: [
        // äºŒé¡¹é€‰æ‹©é¢˜
        {prompt: row.q1, name: 'Q1', options: ['é™ˆè¿°è¯­æ°”','è­¦å‘Šè¯­æ°”'], required: true},

        // 7ç‚¹é‡è¡¨é¢˜ï¼Œæ¨ªå‘æ˜¾ç¤ºï¼Œæ˜¾ç¤ºä¸¤ç«¯å«ä¹‰
        {
          prompt: row.q2,
          name: 'Q2',
          options: ['1','2','3','4','5','6','7'],
          required: true,
          horizontal: true,
          prompt_html: `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
              <span>1 = éå¸¸ä¸é€‚åˆ</span>
              <span>7 = éå¸¸é€‚åˆ</span>
            </div>
            ${row.q2}
          `
        },
        {
          prompt: row.q3,
          name: 'Q3',
          options: ['1','2','3','4','5','6','7'],
          required: true,
          horizontal: true,
          prompt_html: `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
              <span>1 = éå¸¸ä¸æ„‰å¿«</span>
              <span>7 = éå¸¸æ„‰å¿«</span>
            </div>
            ${row.q3}
          `
        },
        {
          prompt: row.q4,
          name: 'Q4',
          options: ['1','2','3','4','5','6','7'],
          required: true,
          horizontal: true,
          prompt_html: `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
              <span>1 = éå¸¸å¹³é™</span>
              <span>7 = éå¸¸æ¿€åŠ¨</span>
            </div>
            ${row.q4}
          `
        },
        {
          prompt: row.q5,
          name: 'Q5',
          options: ['1','2','3','4','5','6','7'],
          required: true,
          horizontal: true,
          prompt_html: `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
              <span>1 = å®Œå…¨æ²¡æœ‰æŒæ§æ„Ÿ</span>
              <span>7 = éå¸¸æœ‰æŒæ§æ„Ÿ</span>
            </div>
            ${row.q5}
          `
        }
      ],
      on_load: function() {
        // ä½¿ç”¨äº‹ä»¶ç›‘å¬å™¨æ›¿ä»£å†…è”è„šæœ¬ï¼Œé¿å…DOMå†²çª
        const replayBtn = document.getElementById("replay-btn");
        replayBtn.addEventListener('click', () => {
          const audio = new Audio(row.audio);
          // å¤„ç†æ’­æ”¾é”™è¯¯
          audio.play().catch(e => {
            alert("æ’­æ”¾å¤±è´¥ï¼Œè¯·ç¡®ä¿å·²å®Œæˆé¦–æ¬¡éŸ³é¢‘æ’­æ”¾");
            console.error("éŸ³é¢‘é‡æ’­é”™è¯¯:", e);
          });
        });
      },
      on_finish: function(data){
        data.phase = row.type; // ä¿å­˜ phase ä¿¡æ¯
        data.audio_filename = row.audio.split('/').pop(); // ä¿å­˜éŸ³é¢‘æ–‡ä»¶å
        // æ›´æ–°å·²å®Œæˆè¯•æ¬¡
        let completed = JSON.parse(localStorage.getItem("completedTrials") || "[]");
        if(!completed.includes(row.audio)){
          completed.push(row.audio);
          localStorage.setItem("completedTrials", JSON.stringify(completed));
        }
      }
    }
  ];
}

// =========================
// 5. åˆ›å»ºç»ƒä¹ æ—¶é—´çº¿
// =========================
function createPracticeTimeline(materials){
  let practice = materials.filter(m => m.type === "practice");
  let timeline = [];
  
  if(practice.length === 0) {
    console.warn("æœªæ‰¾åˆ°ç»ƒä¹ è¯•æ¬¡");
    return timeline;
  }
  
  practice.forEach(row => timeline.push(...createTrial(row)));

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p>ç»ƒä¹ ç»“æŸã€‚è¯·é€‰æ‹©æ“ä½œï¼š</p>",
    choices: ["é‡æ–°ç»ƒä¹ ","è¿›å…¥æ­£å¼å®éªŒ"],
    button_html: '<button class="jspsych-btn">%choice%</button>',
    on_finish: function(data){
      if(data.response == 0){
        // é‡æ–°ç»ƒä¹ æ—¶æ¸…é™¤å·²å®Œæˆçš„ç»ƒä¹ è¯•æ¬¡è®°å½•
        let completed = JSON.parse(localStorage.getItem("completedTrials") || "[]");
        completed = completed.filter(item => !practice.some(p => p.audio === item));
        localStorage.setItem("completedTrials", JSON.stringify(completed));
        
        jsPsych.addNodeToEndOfTimeline(createPracticeTimeline(materials));
      }
    }
  });
  return timeline;
}

// =========================
// 6. åˆ›å»ºæ­£å¼å®éªŒæ—¶é—´çº¿
// =========================
function createFormalTimeline(materials){
  let formal = materials.filter(m => m.type === "formal");
  
  if(formal.length === 0) {
    return [{
      type: jsPsychHtmlButtonResponse,
      stimulus: "<h2>è­¦å‘Š</h2><p>æœªæ‰¾åˆ°æ­£å¼å®éªŒè¯•æ¬¡</p>",
      choices: ["è¿”å›"]
    }];
  }
  
  // éšæœºæ’åºæ­£å¼å®éªŒè¯•æ¬¡
  let shuffledFormal = jsPsych.randomization.shuffle(formal);
  let timeline = [];
  
  shuffledFormal.forEach(row => timeline.push(...createTrial(row)));
  
  // æ·»åŠ å®éªŒç»“æŸé¡µé¢
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `<h2>å®éªŒç»“æŸï¼</h2>
               <p>æ„Ÿè°¢æ‚¨å®Œæˆæ‰€æœ‰å®éªŒå†…å®¹ã€‚</p>
               <p>æ‚¨çš„å®éªŒæ•°æ®å·²è‡ªåŠ¨ä¸‹è½½ä¸ºCSVæ–‡ä»¶ã€‚</p>
               <p>å¦‚æœæ‚¨éœ€è¦é‡æ–°è¿›è¡Œå®éªŒï¼Œå¯ä»¥åˆ·æ–°é¡µé¢å¹¶é€‰æ‹©"ä»å¤´å¼€å§‹"ã€‚</p>`,
    choices: ["å®Œæˆå¹¶å…³é—­"],
    button_html: '<button class="jspsych-btn">%choice%</button>',
    on_finish: function() {
      // å®éªŒå®Œæˆåå¯é€‰æ¸…é™¤æœ¬åœ°å­˜å‚¨
      // localStorage.removeItem("completedTrials");
    }
  });
  
  return timeline;
}

// =========================
// 7. å¯åŠ¨å®éªŒï¼ˆä¼˜åŒ–ç‰ˆï¼‰
// =========================
async function startExperiment(){
  try {
    // æ£€æŸ¥æ˜¯å¦æœ‰å†å²è®°å½•å¹¶è¯¢é—®ç”¨æˆ·
    let completed = JSON.parse(localStorage.getItem("completedTrials") || "[]");
    if(completed.length > 0) {
      // ä¿®æ”¹æç¤ºé€»è¾‘ï¼šç¡®å®š=ç»§ç»­ä¸Šæ¬¡è¿›åº¦ï¼Œå–æ¶ˆ=é‡æ–°å¼€å§‹
      const continueProgress = confirm(`æ£€æµ‹åˆ°æ‚¨æœ‰æœªå®Œæˆçš„å®éªŒè¿›åº¦ã€‚\n\næ˜¯å¦ç»§ç»­ä¸Šæ¬¡çš„è¿›åº¦ï¼Ÿ\n- é€‰æ‹©"ç¡®å®š"å°†ç»§ç»­ä¹‹å‰çš„å®éªŒ\n- é€‰æ‹©"å–æ¶ˆ"å°†æ¸…é™¤è®°å½•å¹¶ä»å¤´å¼€å§‹`);
      
      if(!continueProgress) { // ç”¨æˆ·é€‰æ‹©å–æ¶ˆï¼Œå³é‡æ–°å¼€å§‹
        localStorage.removeItem("completedTrials");
        completed = [];
      }
      // å¦‚æœç”¨æˆ·é€‰æ‹©ç¡®å®šï¼Œåˆ™ä¿æŒç°æœ‰è®°å½•ä¸å˜ï¼Œç»§ç»­è¿›åº¦
    }

    let timeline = [];
    timeline.push(info_form);
    timeline.push(instructions);

    let materials = await loadMaterials();
    
    if(materials.length === 0) {
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: "<h2>å®éªŒå·²å®Œæˆ</h2><p>æ‚¨å·²å®Œæˆæ‰€æœ‰å®éªŒå†…å®¹ï¼Œæ„Ÿè°¢å‚ä¸ï¼</p>",
        choices: ["å…³é—­é¡µé¢"]
      });
    } else {
      // åŠ å…¥ç»ƒä¹ 
      timeline = timeline.concat(createPracticeTimeline(materials));
      // åŠ å…¥æ­£å¼å®éªŒ
      timeline = timeline.concat(createFormalTimeline(materials));
    }

    jsPsych.run(timeline);
  } catch (error) {
    console.error("å®éªŒå¯åŠ¨å¤±è´¥:", error);
  }
}

// å¯åŠ¨å®éªŒ
startExperiment();
</script>
</html>
