<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>音频前测实验</title>
  <!-- 添加favicon避免404错误 -->
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <!-- jsPsych v7 -->
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" />
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    .jspsych-btn {
      margin: 5px;
      padding: 8px 16px;
      cursor: pointer;
    }
    .question-disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .instructions {
      line-height: 1.6;
      margin-bottom: 20px;
    }
    .audio-container {
      margin: 15px 0;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 5px;
    }
    .question-container {
      margin-top: 20px;
    }
  </style>
</head>
<body></body>
<script>
const jsPsych = initJsPsych({
  on_finish: function() {
    const data = jsPsych.data.get();
    data.addProperties({
      experiment_start: new Date(jsPsych.data.get().values()[0]?.time_start || Date.now()).toISOString(),
      experiment_end: new Date().toISOString(),
      duration_seconds: (jsPsych.getTotalTime() / 1000).toFixed(2) // 修复totalTime()为getTotalTime()
    });
    data.localSave('csv','results.csv');
  }
});

// ========== 被试信息 ==========
let info_form = {
  type: jsPsychSurveyHtmlForm,
  preamble: "<h2>被试信息</h2><p>请填写以下信息：</p>",
  html: `
    姓名: <input name="name" type="text" required><br>
    性别: <select name="gender" required>
            <option value="">请选择</option>
            <option value="男">男</option>
            <option value="女">女</option>
          </select><br>
    联系方式: <input name="contact" type="text" required><br>
  `,
  button_label: "继续"
};

// ========== 指导语 ==========
let instructions = {
  type: jsPsychInstructions,
  pages: [
    `<div class="instructions">
      <h2>指导语</h2>
      <p>您将听到一系列音频。每个音频需要先点击播放按钮开始播放，必须完整听完一次后才能回答问题。</p>
      <p>听完后可以再次点击播放按钮重新收听音频。</p>
      <p>请根据您的真实感受作答，答案没有对错之分。</p>
    </div>`
  ],
  show_clickable_nav: true,
  button_label_next: "开始练习",
  button_label_previous: "重新阅读"
};

// ========== 加载材料 ==========
async function loadMaterials(){
  try {
    let response = await fetch("https://gigibon.github.io/Warn_name_audio/materials.csv");
    if(!response.ok) throw new Error(`HTTP错误: ${response.status}`);
    let text = await response.text();

    // 处理中文编码问题，确保正确解析中文
    let parsed = Papa.parse(text, { 
      header: true, 
      skipEmptyLines: true,
      encoding: "UTF-8" // 明确指定编码为UTF-8
    });
    
    if(parsed.errors.length > 0){
      console.error("CSV 解析错误:", parsed.errors);
      throw new Error("CSV 格式错误，请检查文件");
    }

    let data = parsed.data;
    const requiredFields = ['audio','type','q1','q2','q3','q4','q5'];
    data.forEach((row,i) => {
      requiredFields.forEach(f=>{
        if(!row[f]) throw new Error(`CSV 数据不完整，第 ${i+2} 行缺少 ${f} 字段`);
      });
    });

    let completed = JSON.parse(localStorage.getItem("completedTrials")||"[]");
    const remaining = data.filter(r => !completed.includes(r.audio));
    return remaining;

  } catch (error) {
    console.error("材料加载错误:", error);
    jsPsych.run([{
      type: jsPsychHtmlButtonResponse,
      stimulus: `<h2>实验无法启动</h2><p>错误信息: ${error.message}</p>`,
      choices: ["关闭页面"]
    }]);
    throw error;
  }
}

// ========== 生成试次 ==========
function createTrial(row){
  return {
    type: jsPsychSurveyMultiChoice,
    preamble: `
      <div class="audio-container">
        <p>请点击下方播放按钮听取音频（需完整听完一次才能答题）</p>
        <audio id="trial-audio" src="${row.audio}" controls></audio>
      </div>
      <div class="question-container" id="question-container">
        <p>请回答以下问题：</p>
      </div>
    `,
    questions: [
      {prompt: row.q1, name: 'Q1', options: ['陈述语气','警告语气'], required: true},
      {
        prompt: row.q2, name: 'Q2', options: ['1','2','3','4','5','6','7'], required: true,
        horizontal: true,
        prompt_html: `
          <div style="display:flex; justify-content:space-between;">
            <span>1 = 非常不适合</span><span>7 = 非常适合</span>
          </div>${row.q2}`
      },
      {
        prompt: row.q3, name: 'Q3', options: ['1','2','3','4','5','6','7'], required: true,
        horizontal: true,
        prompt_html: `
          <div style="display:flex; justify-content:space-between;">
            <span>1 = 非常不愉快</span><span>7 = 非常愉快</span>
          </div>${row.q3}`
      },
      {
        prompt: row.q4, name: 'Q4', options: ['1','2','3','4','5','6','7'], required: true,
        horizontal: true,
        prompt_html: `
          <div style="display:flex; justify-content:space-between;">
            <span>1 = 非常平静</span><span>7 = 非常激动</span>
          </div>${row.q4}`
      },
      {
        prompt: row.q5, name: 'Q5', options: ['1','2','3','4','5','6','7'], required: true,
        horizontal: true,
        prompt_html: `
          <div style="display:flex; justify-content:space-between;">
            <span>1 = 完全没有掌控感</span><span>7 = 非常有掌控感</span>
          </div>${row.q5}`
      }
    ],
    on_load: function(){
      // 获取元素
      const audioEl = document.getElementById("trial-audio");
      const questionContainer = document.getElementById("question-container");
      const submitButton = document.querySelector('.jspsych-survey-multi-choice-submit');
      const allOptions = document.querySelectorAll('input[type="radio"]');
      
      // 初始状态：问题和提交按钮不可用
      questionContainer.classList.add('question-disabled');
      submitButton.disabled = true;
      allOptions.forEach(option => option.disabled = true);
      
      // 音频播放结束后启用问题和提交按钮
      audioEl.addEventListener("ended", () => {
        questionContainer.classList.remove('question-disabled');
        submitButton.disabled = false;
        allOptions.forEach(option => option.disabled = false);
      });
    },
    on_finish: function(data){
      data.phase = row.type;
      data.audio_filename = row.audio.split('/').pop();
      let completed = JSON.parse(localStorage.getItem("completedTrials")||"[]");
      if(!completed.includes(row.audio)){
        completed.push(row.audio);
        localStorage.setItem("completedTrials", JSON.stringify(completed));
      }
    }
  };
}

// ========== 练习和正式部分 ==========
function createPracticeTimeline(materials){
  let practice = materials.filter(m=>m.type==="practice");
  let tl = [];
  practice.forEach(r=>tl.push(createTrial(r)));
  if(practice.length>0){
    tl.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: "<p>练习结束。请选择操作：</p>",
      choices: ["重新练习","进入正式实验"],
      on_finish: function(d){
        if(d.response==0){
          let completed = JSON.parse(localStorage.getItem("completedTrials")||"[]");
          completed = completed.filter(item=>!practice.some(p=>p.audio===item));
          localStorage.setItem("completedTrials", JSON.stringify(completed));
          jsPsych.addNodeToEndOfTimeline(createPracticeTimeline(materials));
        }
      }
    });
  }
  return tl;
}

function createFormalTimeline(materials){
  let formal = materials.filter(m=>m.type==="formal");
  let tl = [];
  jsPsych.randomization.shuffle(formal).forEach(r=>tl.push(createTrial(r)));
  tl.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: "<h2>实验结束！</h2><p>感谢您的参与！</p>",
    choices: ["完成并关闭"]
  });
  return tl;
}

// ========== 启动实验 ==========
async function startExperiment(){
  let timeline = [info_form, instructions];
  let materials = await loadMaterials();
  if(materials.length===0){
    timeline.push({type: jsPsychHtmlButtonResponse, stimulus:"<p>您已完成所有实验</p>", choices:["关闭"]});
  } else {
    timeline = timeline.concat(createPracticeTimeline(materials));
    timeline = timeline.concat(createFormalTimeline(materials));
  }
  jsPsych.run(timeline);
}
startExperiment();
</script>
</html>
