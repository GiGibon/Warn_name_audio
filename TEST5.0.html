<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>éŸ³é¢‘å‰æµ‹å®éªŒ</title>
  <!-- jsPsych v7 -->
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" />
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    .jspsych-btn {
      margin: 5px;
      padding: 8px 16px;
      cursor: pointer;
    }
    #replay-btn {
      margin: 15px 0;
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #replay-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .instructions {
      line-height: 1.6;
      margin-bottom: 20px;
    }
  </style>
</head>
<body></body>
<script>
const jsPsych = initJsPsych({
  on_finish: function() {
    const data = jsPsych.data.get();
    data.addProperties({
      experiment_start: new Date(jsPsych.data.get().values()[0]?.time_start || Date.now()).toISOString(),
      experiment_end: new Date().toISOString(),
      duration_seconds: (jsPsych.totalTime() / 1000).toFixed(2)
    });
    data.localSave('csv','results.csv');
  }
});

// ========== è¢«è¯•ä¿¡æ¯ ==========
let info_form = {
  type: jsPsychSurveyHtmlForm,
  preamble: "<h2>è¢«è¯•ä¿¡æ¯</h2><p>è¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š</p>",
  html: `
    å§“å: <input name="name" type="text" required><br>
    æ€§åˆ«: <select name="gender" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="ç”·">ç”·</option>
            <option value="å¥³">å¥³</option>
          </select><br>
    è”ç³»æ–¹å¼: <input name="contact" type="text" required><br>
  `,
  button_label: "ç»§ç»­"
};

// ========== æŒ‡å¯¼è¯­ ==========
let instructions = {
  type: jsPsychInstructions,
  pages: [
    `<div class="instructions">
      <h2>æŒ‡å¯¼è¯­</h2>
      <p>æ‚¨å°†å¬åˆ°ä¸€ç³»åˆ—éŸ³é¢‘ã€‚æ¯ä¸ªéŸ³é¢‘éœ€è¦å…ˆç‚¹å‡»æŒ‰é’®å¼€å§‹æ’­æ”¾ï¼Œå¹¶ä¸”å¿…é¡»å®Œæ•´å¬å®Œä¸€æ¬¡ï¼Œç„¶åå›ç­”é—®é¢˜ã€‚</p>
      <p>ç­”é¢˜é¡µé¢å¯ä»¥ç‚¹å‡»"å†å¬ä¸€æ¬¡"æŒ‰é’®å›æ”¾éŸ³é¢‘ã€‚</p>
      <p>è¯·æ ¹æ®æ‚¨çš„çœŸå®æ„Ÿå—ä½œç­”ï¼Œç­”æ¡ˆæ²¡æœ‰å¯¹é”™ä¹‹åˆ†ã€‚</p>
    </div>`
  ],
  show_clickable_nav: true,
  button_label_next: "å¼€å§‹ç»ƒä¹ ",
  button_label_previous: "é‡æ–°é˜…è¯»"
};

// ========== åŠ è½½ææ–™ ==========
async function loadMaterials(){
  try {
    let response = await fetch("https://gigibon.github.io/Warn_name_audio/materials.csv");
    if(!response.ok) throw new Error(`HTTPé”™è¯¯: ${response.status}`);
    let text = await response.text();

    let parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    if(parsed.errors.length > 0){
      console.error("CSV è§£æé”™è¯¯:", parsed.errors);
      throw new Error("CSV æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶");
    }

    let data = parsed.data;
    const requiredFields = ['audio','type','q1','q2','q3','q4','q5'];
    data.forEach((row,i) => {
      requiredFields.forEach(f=>{
        if(!row[f]) throw new Error(`CSV æ•°æ®ä¸å®Œæ•´ï¼Œç¬¬ ${i+2} è¡Œç¼ºå°‘ ${f} å­—æ®µ`);
      });
    });

    let completed = JSON.parse(localStorage.getItem("completedTrials")||"[]");
    const remaining = data.filter(r => !completed.includes(r.audio));
    return remaining;

  } catch (error) {
    console.error("ææ–™åŠ è½½é”™è¯¯:", error);
    jsPsych.run([{
      type: jsPsychHtmlButtonResponse,
      stimulus: `<h2>å®éªŒæ— æ³•å¯åŠ¨</h2><p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>`,
      choices: ["å…³é—­é¡µé¢"]
    }]);
    throw error;
  }
}

// ========== ç”Ÿæˆè¯•æ¬¡ ==========
function createTrial(row){
  return [
    {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <p>è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ’­æ”¾éŸ³é¢‘ï¼ˆè¯·å®Œæ•´å¬å®Œï¼‰</p>
        <audio id="trial-audio" src="${row.audio}" controls></audio>
      `,
      choices: ["ç»§ç»­"],
      trial_duration: null,
      on_load: function(){
        const audioEl = document.getElementById("trial-audio");
        const btns = document.querySelectorAll(".jspsych-btn");
        btns.forEach(btn=>btn.disabled = true);
        audioEl.addEventListener("ended", () => {
          btns.forEach(btn=>btn.disabled = false);
        });
      }
    },
    {
      type: jsPsychSurveyMultiChoice,
      preamble: `
        <button id="replay-btn">ğŸ”Š å†å¬ä¸€æ¬¡</button>
        <p>è¯·å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š</p>
      `,
      questions: [
        {prompt: row.q1, name: 'Q1', options: ['é™ˆè¿°è¯­æ°”','è­¦å‘Šè¯­æ°”'], required: true},
        {
          prompt: row.q2, name: 'Q2', options: ['1','2','3','4','5','6','7'], required: true,
          horizontal: true,
          prompt_html: `
            <div style="display:flex; justify-content:space-between;">
              <span>1 = éå¸¸ä¸é€‚åˆ</span><span>7 = éå¸¸é€‚åˆ</span>
            </div>${row.q2}`
        },
        {
          prompt: row.q3, name: 'Q3', options: ['1','2','3','4','5','6','7'], required: true,
          horizontal: true,
          prompt_html: `
            <div style="display:flex; justify-content:space-between;">
              <span>1 = éå¸¸ä¸æ„‰å¿«</span><span>7 = éå¸¸æ„‰å¿«</span>
            </div>${row.q3}`
        },
        {
          prompt: row.q4, name: 'Q4', options: ['1','2','3','4','5','6','7'], required: true,
          horizontal: true,
          prompt_html: `
            <div style="display:flex; justify-content:space-between;">
              <span>1 = éå¸¸å¹³é™</span><span>7 = éå¸¸æ¿€åŠ¨</span>
            </div>${row.q4}`
        },
        {
          prompt: row.q5, name: 'Q5', options: ['1','2','3','4','5','6','7'], required: true,
          horizontal: true,
          prompt_html: `
            <div style="display:flex; justify-content:space-between;">
              <span>1 = å®Œå…¨æ²¡æœ‰æŒæ§æ„Ÿ</span><span>7 = éå¸¸æœ‰æŒæ§æ„Ÿ</span>
            </div>${row.q5}`
        }
      ],
      on_load: function(){
        document.getElementById("replay-btn").addEventListener("click", ()=>{
          const audioEl = document.getElementById("trial-audio");
          if(audioEl){ audioEl.currentTime = 0; audioEl.play(); }
        });
      },
      on_finish: function(data){
        data.phase = row.type;
        data.audio_filename = row.audio.split('/').pop();
        let completed = JSON.parse(localStorage.getItem("completedTrials")||"[]");
        if(!completed.includes(row.audio)){
          completed.push(row.audio);
          localStorage.setItem("completedTrials", JSON.stringify(completed));
        }
      }
    }
  ];
}

// ========== ç»ƒä¹ å’Œæ­£å¼éƒ¨åˆ† ==========
function createPracticeTimeline(materials){
  let practice = materials.filter(m=>m.type==="practice");
  let tl = [];
  practice.forEach(r=>tl.push(...createTrial(r)));
  if(practice.length>0){
    tl.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: "<p>ç»ƒä¹ ç»“æŸã€‚è¯·é€‰æ‹©æ“ä½œï¼š</p>",
      choices: ["é‡æ–°ç»ƒä¹ ","è¿›å…¥æ­£å¼å®éªŒ"],
      on_finish: function(d){
        if(d.response==0){
          let completed = JSON.parse(localStorage.getItem("completedTrials")||"[]");
          completed = completed.filter(item=>!practice.some(p=>p.audio===item));
          localStorage.setItem("completedTrials", JSON.stringify(completed));
          jsPsych.addNodeToEndOfTimeline(createPracticeTimeline(materials));
        }
      }
    });
  }
  return tl;
}

function createFormalTimeline(materials){
  let formal = materials.filter(m=>m.type==="formal");
  let tl = [];
  jsPsych.randomization.shuffle(formal).forEach(r=>tl.push(...createTrial(r)));
  tl.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: "<h2>å®éªŒç»“æŸï¼</h2><p>æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼</p>",
    choices: ["å®Œæˆå¹¶å…³é—­"]
  });
  return tl;
}

// ========== å¯åŠ¨å®éªŒ ==========
async function startExperiment(){
  let timeline = [info_form, instructions];
  let materials = await loadMaterials();
  if(materials.length===0){
    timeline.push({type: jsPsychHtmlButtonResponse, stimulus:"<p>æ‚¨å·²å®Œæˆæ‰€æœ‰å®éªŒ</p>", choices:["å…³é—­"]});
  } else {
    timeline = timeline.concat(createPracticeTimeline(materials));
    timeline = timeline.concat(createFormalTimeline(materials));
  }
  jsPsych.run(timeline);
}
startExperiment();
</script>
</html>
