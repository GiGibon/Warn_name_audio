<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>音频前测实验</title>
  <link rel="icon" href="data:,">
  <style>
    body { 
      font-family: "微软雅黑", "Arial", sans-serif; 
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    .jspsych-btn { 
      margin: 5px; 
      padding: 12px 24px; 
      cursor: pointer; 
      background-color: #4a6fa5;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    .jspsych-btn:hover {
      background-color: #385d8a;
    }
    .jspsych-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .instructions { 
      line-height: 1.6; 
      margin-bottom: 20px; 
      text-align: left;
    }
    fieldset { 
      border: 1px solid #ddd; 
      margin: 15px 0; 
      padding: 15px; 
      background-color: white; 
      border-radius: 5px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    legend { 
      font-weight: bold; 
      margin-bottom: 5px; 
      color: #4a6fa5;
      padding: 0 10px;
    }
    input[type=radio] { 
      margin-right: 5px;
    }
    input[type=radio][disabled] { 
      cursor: not-allowed; 
    }
    .loading { 
      text-align: center; 
      padding: 40px; 
      font-size: 18px;
      color: #4a6fa5;
    }
    .error-message { 
      color: #dc3545; 
      padding: 20px; 
      text-align: center; 
      background-color: #f8d7da;
      border-radius: 5px; 
      margin: 20px;
      border: 1px solid #f5c6cb;
    }
    #intro { 
      max-width: 500px; 
      margin: 50px auto; 
      padding: 30px; 
      border: 1px solid #ddd; 
      border-radius: 10px; 
      background-color: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .form-group { 
      margin-bottom: 20px; 
    }
    label { 
      display: inline-block; 
      margin-right: 15px; 
      margin-bottom: 10px;
    }
    input[type="text"] {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
      margin-top: 5px;
      font-size: 16px;
    }
    button {
      padding: 10px 20px;
      background-color: #4a6fa5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #385d8a;
    }
    #jspsych-target {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .trial-container {
      max-width: 700px;
      margin: 0 auto;
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .progress-container {
      margin: 20px auto;
      max-width: 700px;
      background-color: #f0f0f0;
      border-radius: 10px;
      height: 20px;
    }
    .progress-bar {
      height: 100%;
      background-color: #4a6fa5;
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s;
    }
    .audio-controls {
      text-align: center;
      margin: 20px 0;
    }
    .center-content {
      text-align: center;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4a6fa5;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .resource-status {
      font-size: 14px;
      margin: 5px 0;
    }
    .trial-number {
      color: #666;
      font-size: 14px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <!-- ====== 被试输入界面 ====== -->
  <div id="intro">
    <h2 style="text-align: center; color: #4a6fa5;">音频感知实验</h2>
    <p>请输入您的姓名和编号后开始：</p>
    <div class="form-group">
      <label for="participantName">姓名:</label>
      <input id="participantName" type="text" required>
    </div>
    <div class="form-group">
      <label for="participantId">编号:</label>
      <input id="participantId" type="text" required>
    </div>
    <div style="text-align: center; margin-top: 25px;">
      <button onclick="startExperiment()">进入实验</button>
      <button onclick="resetExperiment()" style="background-color: #6c757d;">重置实验</button>
    </div>
    
    <!-- 资源加载状态 -->
    <div id="resource-loading" style="margin-top: 20px; padding: 10px; background: #f0f8ff; border-radius: 5px;">
      <p>正在加载实验资源...</p>
      <div id="resource-status"></div>
      <div class="spinner" style="width: 20px; height: 20px;"></div>
    </div>
  </div>

  <div id="progress-container" class="progress-container" style="display: none;">
    <div id="progress-bar" class="progress-bar"></div>
  </div>

  <div id="jspsych-target" style="display:none;"></div>

  <script>
    // 资源加载状态
    let resourcesLoaded = {
      jsPsych: false,
      plugins: {
        survey: false,
        instructions: false,
        buttonResponse: false
      },
      papaParse: false
    };

    // 添加资源加载状态显示
    function updateResourceStatus(name, status) {
      const statusEl = document.getElementById('resource-status');
      const color = status ? 'green' : 'orange';
      const symbol = status ? '✓' : '…';
      statusEl.innerHTML += `<div class="resource-status"><span style="color: ${color}">${symbol}</span> ${name}</div>`;
    }

    // 尝试加载资源
    function loadResource(url, type, name, callback) {
      return new Promise((resolve, reject) => {
        const element = type === 'script' ? document.createElement('script') : document.createElement('link');
        
        if (type === 'script') {
          element.src = url;
          element.onload = () => {
            if (callback) callback();
            updateResourceStatus(name, true);
            resolve();
          };
          element.onerror = () => {
            console.error(`Failed to load script: ${url}`);
            updateResourceStatus(`${name} (加载失败)`, false);
            reject(new Error(`Failed to load script: ${url}`));
          };
        } else {
          element.rel = 'stylesheet';
          element.href = url;
          element.onload = () => {
            if (callback) callback();
            updateResourceStatus(name, true);
            resolve();
          };
          element.onerror = () => {
            console.error(`Failed to load stylesheet: ${url}`);
            updateResourceStatus(`${name} (加载失败)`, false);
            reject(new Error(`Failed to load stylesheet: ${url}`));
          };
        }
        
        document.head.appendChild(element);
      });
    }

    // 加载所有必要资源 - 使用稳定的jsDelivr CDN链接
    async function loadAllResources() {
      try {
        // 清空状态
        document.getElementById('resource-status').innerHTML = '';
        
        // 加载jsPsych核心库
        await loadResource(
          'https://cdn.jsdelivr.net/npm/jspsych@7.3.3/dist/jspsych.min.js', 
          'script', 
          'jsPsych核心库',
          () => { resourcesLoaded.jsPsych = true; }
        );
        
        // 加载插件
        await loadResource(
          'https://cdn.jsdelivr.net/npm/@jspsych/plugin-survey-html-form@1.1.1/dist/index.umd.min.js', 
          'script', 
          '问卷表单插件',
          () => { resourcesLoaded.plugins.survey = true; }
        );
        
        await loadResource(
          'https://cdn.jsdelivr.net/npm/@jspsych/plugin-instructions@1.1.1/dist/index.umd.min.js', 
          'script', 
          '指导语插件',
          () => { resourcesLoaded.plugins.instructions = true; }
        );
        
        await loadResource(
          'https://cdn.jsdelivr.net/npm/@jspsych/plugin-html-button-response@1.1.1/dist/index.umd.min.js', 
          'script', 
          '按钮响应插件',
          () => { resourcesLoaded.plugins.buttonResponse = true; }
        );
        
        // 加载CSS
        await loadResource(
          'https://cdn.jsdelivr.net/npm/jspsych@7.3.3/css/jspsych.min.css', 
          'stylesheet', 
          '实验样式表'
        );
        
        // 加载PapaParse
        await loadResource(
          'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js', 
          'script', 
          '数据解析库',
          () => { resourcesLoaded.papaParse = true; }
        );
        
        console.log('所有资源加载成功');
        document.getElementById('resource-loading').innerHTML = `
          <p style="color: green;">✅ 实验资源加载完成，可以开始实验</p>
        `;
        return true;
      } catch (error) {
        console.error('资源加载失败:', error);
        document.getElementById('resource-loading').innerHTML += `
          <p style="color: red;">❌ 部分资源加载失败，请检查网络连接后刷新页面重试</p>
          <button onclick="window.location.reload()">刷新页面</button>
        `;
        return false;
      }
    }

    // 初始化页面
    document.addEventListener('DOMContentLoaded', async function() {
      await loadAllResources();
    });
  </script>

  <script>
    // 实验主要逻辑
    let participantId = null;
    let participantName = null;
    let jsPsych;
    let allMaterials = [];
    let totalTrials = 0;
    let completedTrials = 0;
    let practiceTrialsCount = 0;
    let formalTrialsCount = 0;
    let batchSize = 50; // 每批加载50条，可根据需要调整
    let currentBatch = 0;
    let loadedMaterials = [];

    // 初始化jsPsych
    function initJsPsych() {
      // 检查jsPsych是否已加载
      if (typeof window.jsPsych === 'undefined') {
        throw new Error("jsPsych未正确加载，请检查网络连接并刷新页面");
      }
      
      return window.jsPsych.init({
        display_element: document.getElementById("jspsych-target"),
        on_finish: function() {
          // 标记完成
          localStorage.setItem("exp_done_" + participantId, "true");

          // 保存 CSV
          const data = jsPsych.data.get();
          data.addProperties({
            participant_id: participantId,
            participant_name: participantName,
            experiment_start: new Date().toISOString(),
            experiment_end: new Date().toISOString(),
            duration_seconds: (jsPsych.getTotalTime() / 1000).toFixed(2)
          });
          
          // 尝试保存数据
          try {
            data.localSave('csv', `results_${participantId}.csv`);
          } catch (e) {
            console.error("保存数据失败:", e);
          }

          // 实验结束提示
          document.getElementById("jspsych-target").innerHTML = `
            <div class="trial-container">
              <h2>实验结束！</h2>
              <p>感谢您的参与！您的实验数据已保存。</p>
              <p>文件名: results_${participantId}.csv</p>
              <div class="center-content" style="margin-top: 20px;">
                <button class="jspsych-btn" onclick="returnToIntro()">返回首页</button>
              </div>
            </div>
          `;
        }
      });
    }

    // 更新进度条
    function updateProgressBar() {
      if (totalTrials > 0) {
        const progress = (completedTrials / totalTrials) * 100;
        document.getElementById("progress-bar").style.width = `${progress}%`;
      }
    }

    // 返回初始界面
    function returnToIntro() {
      document.getElementById("jspsych-target").style.display = "none";
      document.getElementById("progress-container").style.display = "none";
      document.getElementById("intro").style.display = "block";
      document.getElementById("participantName").value = "";
      document.getElementById("participantId").value = "";
      participantId = null;
      participantName = null;
      allMaterials = [];
      loadedMaterials = [];
      currentBatch = 0;
    }

    // 重置实验
    function resetExperiment() {
      const currentId = document.getElementById("participantId").value.trim();
      if (currentId && confirm(`确定要重置编号为 ${currentId} 的实验数据吗？`)) {
        localStorage.removeItem("exp_done_" + currentId);
        localStorage.removeItem(`completedTrials_${currentId}`);
        alert("实验已重置，可以重新开始");
      } else if (!currentId) {
        alert("请先输入要重置的编号");
      }
    }

    // 从数据源获取材料（可根据实际情况修改）
    async function fetchMaterialsFromSource() {
      // 实际应用中，替换为从CSV或服务器获取数据
      try {
        // 示例：从CSV文件加载（推荐方式）
        const response = await fetch("materials.csv");
        if (!response.ok) {
          throw new Error(`无法加载材料文件: ${response.status}`);
        }
        const text = await response.text();
        const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
        
        // 验证必要字段
        const requiredFields = ['audio', 'type', 'q1', 'q2', 'q3', 'q4', 'q5'];
        parsed.data.forEach((row, i) => {
          requiredFields.forEach(field => {
            if (!row[field]) {
              throw new Error(`材料数据不完整，第 ${i+2} 行缺少 ${field} 字段`);
            }
          });
        });
        
        return parsed.data;
      } catch (error) {
        console.error("从CSV加载材料失败，使用模拟数据:", error);
        
        // 模拟数据（实际使用时删除）
        const mockMaterials = [];
        const practiceCount = 10; // 10条练习数据
        const totalCount = 2000; // 总共2000条数据
        
        for (let i = 1; i <= totalCount; i++) {
          mockMaterials.push({
            audio: `audio/${i}.mp3`, // 假设音频文件路径
            type: i <= practiceCount ? "practice" : "formal",
            q1: "这个音频的语气是？",
            q2: "这个音频的适合程度如何？",
            q3: "这个音频让你感到愉快吗？",
            q4: "这个音频让你感到激动吗？",
            q5: "这个音频给你多大的掌控感？"
          });
        }
        return mockMaterials;
      }
    }

    // 批量加载材料（分批次加载，适合大量数据）
    async function loadNextBatch() {
      const startIndex = currentBatch * batchSize;
      const endIndex = Math.min(startIndex + batchSize, allMaterials.length);
      
      // 提取当前批次的材料
      const batchMaterials = allMaterials.slice(startIndex, endIndex);
      
      // 添加到已加载材料中
      loadedMaterials = [...loadedMaterials, ...batchMaterials];
      currentBatch++;
      
      console.log(`已加载第 ${currentBatch} 批材料，共 ${loadedMaterials.length}/${allMaterials.length} 条`);
      return batchMaterials;
    }

    // 检查是否需要加载下一批
    async function ensureMaterialsLoaded() {
      // 当剩余材料不足10条时，加载下一批
      const remaining = loadedMaterials.length - completedTrials;
      if (remaining < 10 && currentBatch * batchSize < allMaterials.length) {
        console.log("准备加载下一批材料...");
        await loadNextBatch();
      }
    }

    // ========== 材料加载 ==========
    async function loadMaterials(){
      try {
        // 获取所有材料信息（仅元数据，不加载音频文件）
        allMaterials = await fetchMaterialsFromSource();
        
        // 随机排序（可选，根据实验设计决定）
        allMaterials.sort(() => 0.5 - Math.random());
        
        // 计算练习和正式试次数量
        practiceTrialsCount = allMaterials.filter(m => m.type === "practice").length;
        formalTrialsCount = allMaterials.length - practiceTrialsCount;
        
        // 加载第一批材料
        await loadNextBatch();
        
        if (loadedMaterials.length === 0) {
          throw new Error("未找到任何实验材料，请检查数据源");
        }
        
        return true;
      } catch (error) {
        console.error("加载材料失败:", error);
        throw new Error(`无法加载实验材料: ${error.message}`);
      }
    }

    // ========== 生成单个试次 ==========
    function createTrial(row, trialIndex) {
      return {
        type: 'html-button-response',
        stimulus: `
          <div class="trial-container">
            <div class="trial-number">试次 ${trialIndex + 1}/${totalTrials} (${row.type === 'practice' ? '练习' : '正式'})</div>
            <p>请播放并完整听完音频，然后回答以下问题：</p>
            <div class="audio-controls">
              <audio id="trial-audio-${trialIndex}" src="${row.audio}" controls preload="auto" style="margin: 15px 0; width: 100%;"> 
                您的浏览器不支持音频播放
              </audio>
              <div id="audio-status-${trialIndex}" style="margin-top: 10px; color: #666;"></div>
            </div>
            <form id="survey-form-${trialIndex}">
              <fieldset><legend>${row.q1}</legend>
                <label><input type="radio" name="Q1" value="陈述语气" disabled> 陈述语气</label>
                <label><input type="radio" name="Q1" value="警告语气" disabled> 警告语气</label>
              </fieldset>
              <fieldset><legend>${row.q2}</legend>
                <div style="display:flex; justify-content:space-between;"><span>1=非常不适合</span><span>7=非常适合</span></div>
                ${[1,2,3,4,5,6,7].map(v=>`<label><input type="radio" name="Q2" value="${v}" disabled> ${v}</label>`).join(' ')}
              </fieldset>
              <fieldset><legend>${row.q3}</legend>
                <div style="display:flex; justify-content:space-between;"><span>1=非常不愉快</span><span>7=非常愉快</span></div>
                ${[1,2,3,4,5,6,7].map(v=>`<label><input type="radio" name="Q3" value="${v}" disabled> ${v}</label>`).join(' ')}
              </fieldset>
              <fieldset><legend>${row.q4}</legend>
                <div style="display:flex; justify-content:space-between;"><span>1=非常平静</span><span>7=非常激动</span></div>
                ${[1,2,3,4,5,6,7].map(v=>`<label><input type="radio" name="Q4" value="${v}" disabled> ${v}</label>`).join(' ')}
              </fieldset>
              <fieldset><legend>${row.q5}</legend>
                <div style="display:flex; justify-content:space-between;"><span>1=完全没有掌控感</span><span>7=非常有掌控感</span></div>
                ${[1,2,3,4,5,6,7].map(v=>`<label><input type="radio" name="Q5" value="${v}" disabled> ${v}</label>`).join(' ')}
              </fieldset>
            </form>
          </div>
        `,
        choices: ["提交答案"],
        on_load: function(){
          const trialId = trialIndex;
          const audioEl = document.getElementById(`trial-audio-${trialId}`);
          const statusEl = document.getElementById(`audio-status-${trialId}`);
          const btns = document.querySelectorAll(`#survey-form-${trialId} input[type=radio]`);
          const submitBtn = document.querySelector(".jspsych-btn");
          submitBtn.disabled = true;
          
          // 音频加载状态更新
          audioEl.addEventListener("loadstart", () => {
            statusEl.textContent = "音频加载中...";
          });
          
          audioEl.addEventListener("loadedmetadata", () => {
            statusEl.textContent = `音频时长: ${Math.floor(audioEl.duration)}秒`;
          });
          
          // 音频播放错误处理
          audioEl.addEventListener("error", () => {
            statusEl.textContent = "⚠️ 音频加载失败，仍可提交答案";
            statusEl.style.color = "#dc3545";
            // 即使出错也允许用户提交
            btns.forEach(b => b.disabled = false);
            submitBtn.disabled = false;
          });
          
          // 确保音频播放完成后才能选择答案
          audioEl.addEventListener("ended", () => {
            btns.forEach(b => b.disabled = false);
            submitBtn.disabled = false;
            statusEl.textContent = "音频已播放完毕，可以开始答题";
            statusEl.style.color = "#28a745";
          });
          
          // 如果用户手动暂停后又播放，确保状态正确
          audioEl.addEventListener("play", () => {
            if (audioEl.ended) {
              btns.forEach(b => b.disabled = false);
              submitBtn.disabled = false;
            }
          });
        },
        on_finish: function(data){
          let formData = {};
          const form = document.getElementById(`survey-form-${trialIndex}`);
          if (form) {
            new FormData(form).forEach((val,key)=>{formData[key]=val;});
          }
          
          data.responses = formData;
          data.phase = row.type;
          data.audio_filename = row.audio.split('/').pop();
          data.trial_number = trialIndex + 1;

          const completedKey = `completedTrials_${participantId}`;
          let completed = JSON.parse(localStorage.getItem(completedKey)||"[]");
          if(!completed.includes(row.audio)){
            completed.push(row.audio);
            localStorage.setItem(completedKey, JSON.stringify(completed));
          }
          
          // 更新进度
          completedTrials++;
          updateProgressBar();
          
          // 提前加载下一批材料
          ensureMaterialsLoaded();
        }
      };
    }

    // 生成实验流程
    function createTimeline() {
      const timeline = [];

      // 添加确认信息页面
      timeline.push({
        type: 'survey-html-form',
        preamble: "<h2>确认信息</h2>",
        html: `<p><b>姓名:</b> ${participantName}</p><p><b>编号:</b> ${participantId}</p>`,
        button_label: "确认并继续"
      });

      // 添加指导语
      timeline.push({
        type: 'instructions',
        pages: [
          `<div class="instructions">
            <h2>指导语</h2>
            <p>欢迎参加音频感知实验！</p>
            <p>您将听到一系列音频，每次答题时需要完整听完音频，然后作答。</p>
            <p>请根据您的真实感受作答，没有对错之分。</p>
            <p>实验包含 ${practiceTrialsCount} 个练习试次和 ${formalTrialsCount} 个正式试次，请按照提示进行操作。</p>
            <p>完成整个实验大约需要30-40分钟，请确保在安静的环境中完成实验。</p>
          </div>`
        ],
        show_clickable_nav: true,
        button_label_next: "开始练习",
        button_label_previous: "返回"
      });

      // 生成试次流程
      const addTrialsToTimeline = () => {
        // 过滤出当前需要的试次（练习和正式）
        const practiceTrials = loadedMaterials
          .filter(m => m.type === "practice")
          .map((row, index) => createTrial(row, index));
        
        if (practiceTrials.length > 0) {
          timeline.push(...practiceTrials);
          
          // 添加练习结束提示
          timeline.push({
            type: 'instructions',
            pages: [
              `<div class="instructions">
                <h2>练习结束</h2>
                <p>您已完成练习部分，接下来将开始正式实验。</p>
                <p>正式实验共有 ${formalTrialsCount} 个试次，流程与练习部分相同，请继续认真作答。</p>
              </div>`
            ],
            show_clickable_nav: true,
            button_label_next: "开始正式实验"
          });
        }
        
        // 正式试次（从练习试次之后开始编号）
        const formalStartIndex = practiceTrialsCount;
        const formalTrials = loadedMaterials
          .filter(m => m.type === "formal")
          .map((row, index) => createTrial(row, formalStartIndex + index));
        
        timeline.push(...formalTrials);
      };
      
      addTrialsToTimeline();
      return timeline;
    }

    // ========== 启动实验 ==========
    async function startExperiment() {
      // 检查资源是否已加载
      if (!resourcesLoaded.jsPsych || !resourcesLoaded.plugins.survey || 
          !resourcesLoaded.plugins.instructions || !resourcesLoaded.plugins.buttonResponse) {
        alert("实验资源尚未加载完成，请稍后再试或刷新页面");
        return;
      }

      participantName = document.getElementById("participantName").value.trim();
      participantId = document.getElementById("participantId").value.trim();

      if (!participantName || !participantId) {
        alert("请输入姓名和编号！");
        return;
      }

      if (localStorage.getItem("exp_done_" + participantId)) {
        if (!confirm("该编号已经完成过实验，继续将覆盖之前的记录。是否继续？")) {
          return;
        }
      }

      document.getElementById("intro").style.display = "none";
      document.getElementById("jspsych-target").style.display = "block";
      document.getElementById("progress-container").style.display = "block";

      // 显示加载提示
      document.getElementById("jspsych-target").innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>正在加载实验材料，请稍候...</p>
          <p id="material-loading-status">准备加载材料信息...</p>
        </div>
      `;

      try {
        document.getElementById("material-loading-status").textContent = "正在加载材料列表...";
        await loadMaterials();
        
        // 设置总试次数和进度条
        totalTrials = allMaterials.length;
        completedTrials = 0;
        updateProgressBar();
      } catch (error) {
        document.getElementById("jspsych-target").innerHTML = `
          <div class="error-message">
            <h3>加载实验材料出错</h3>
            <p>${error.message}</p>
            <p>请检查网络连接后重试，或联系实验负责人。</p>
            <div class="center-content" style="margin-top: 20px;">
              <button class="jspsych-btn" onclick="returnToIntro()">返回首页</button>
            </div>
          </div>
        `;
        console.error("材料加载错误:", error);
        return;
      }

      try {
        // 初始化jsPsych
        jsPsych = initJsPsych();
      } catch (error) {
        document.getElementById("jspsych-target").innerHTML = `
          <div class="error-message">
            <h3>初始化实验环境失败</h3>
            <p>${error.message}</p>
            <p>请刷新页面后重试，或联系实验负责人。</p>
            <div class="center-content" style="margin-top: 20px;">
              <button class="jspsych-btn" onclick="returnToIntro()">返回首页</button>
              <button class="jspsych-btn" onclick="window.location.reload()">刷新页面</button>
            </div>
          </div>
        `;
        console.error("jsPsych初始化错误:", error);
        return;
      }

      // 运行实验
      const timeline = createTimeline();
      jsPsych.run(timeline);
    }
  </script>
</body>
</html>
