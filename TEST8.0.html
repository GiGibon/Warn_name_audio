<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>音频前测实验</title>
  <link rel="icon" href="data:,">
  <!-- 使用本地jsPsych库以避免CDN问题 -->
  <script src="https://unpkg.com/jspsych@7.3.3/dist/jspsych.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.1.1/dist/index.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.1/dist/index.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.1/dist/index.js"></script>
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" />
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { 
      font-family: "微软雅黑", "Arial", sans-serif; 
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    .jspsych-btn { 
      margin: 5px; 
      padding: 12px 24px; 
      cursor: pointer; 
      background-color: #4a6fa5;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    .jspsych-btn:hover {
      background-color: #385d8a;
    }
    .jspsych-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .instructions { 
      line-height: 1.6; 
      margin-bottom: 20px; 
      text-align: left;
    }
    fieldset { 
      border: 1px solid #ddd; 
      margin: 15px 0; 
      padding: 15px; 
      background-color: white; 
      border-radius: 5px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    legend { 
      font-weight: bold; 
      margin-bottom: 5px; 
      color: #4a6fa5;
      padding: 0 10px;
    }
    input[type=radio] { 
      margin-right: 5px;
    }
    input[type=radio][disabled] { 
      cursor: not-allowed; 
    }
    .loading { 
      text-align: center; 
      padding: 40px; 
      font-size: 18px;
      color: #4a6fa5;
    }
    .error-message { 
      color: #dc3545; 
      padding: 20px; 
      text-align: center; 
      background-color: #f8d7da;
      border-radius: 5px;
      margin: 20px;
      border: 1px solid #f5c6cb;
    }
    #intro { 
      max-width: 500px; 
      margin: 50px auto; 
      padding: 30px; 
      border: 1px solid #ddd; 
      border-radius: 10px; 
      background-color: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .form-group { 
      margin-bottom: 20px; 
    }
    label { 
      display: inline-block; 
      margin-right: 15px; 
      margin-bottom: 10px;
    }
    input[type="text"] {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
      margin-top: 5px;
      font-size: 16px;
    }
    button {
      padding: 10px 20px;
      background-color: #4a6fa5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #385d8a;
    }
    #jspsych-target {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .trial-container {
      max-width: 700px;
      margin: 0 auto;
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .progress-container {
      margin: 20px auto;
      max-width: 700px;
      background-color: #f0f0f0;
      border-radius: 10px;
      height: 20px;
    }
    .progress-bar {
      height: 100%;
      background-color: #4a6fa5;
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s;
    }
    .audio-controls {
      text-align: center;
      margin: 20px 0;
    }
    .center-content {
      text-align: center;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4a6fa5;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- ====== 被试输入界面 ====== -->
  <div id="intro">
    <h2 style="text-align: center; color: #4a6fa5;">音频感知实验</h2>
    <p>请输入您的姓名和编号后开始：</p>
    <div class="form-group">
      <label for="participantName">姓名:</label>
      <input id="participantName" type="text" required>
    </div>
    <div class="form-group">
      <label for="participantId">编号:</label>
      <input id="participantId" type="text" required>
    </div>
    <div style="text-align: center; margin-top: 25px;">
      <button onclick="startExperiment()">进入实验</button>
      <button onclick="resetExperiment()" style="background-color: #6c757d;">重置实验</button>
    </div>
  </div>

  <div id="progress-container" class="progress-container" style="display: none;">
    <div id="progress-bar" class="progress-bar"></div>
  </div>

  <div id="jspsych-target" style="display:none;"></div>

<script>
let participantId = null;
let participantName = null;
let jsPsych;
let allMaterials = [];
let totalTrials = 0;
let completedTrials = 0;

// 初始化jsPsych
function initJsPsych() {
  return window.jsPsych.init({
    display_element: document.getElementById("jspsych-target"),
    on_finish: function() {
      // 标记完成
      localStorage.setItem("exp_done_" + participantId, "true");

      // 保存 CSV
      const data = jsPsych.data.get();
      data.addProperties({
        participant_id: participantId,
        participant_name: participantName,
        experiment_start: new Date().toISOString(),
        experiment_end: new Date().toISOString(),
        duration_seconds: (jsPsych.getTotalTime() / 1000).toFixed(2)
      });
      
      // 尝试保存数据
      try {
        data.localSave('csv', `results_${participantId}.csv`);
      } catch (e) {
        console.error("保存数据失败:", e);
      }

      // 实验结束提示
      document.getElementById("jspsych-target").innerHTML = `
        <div class="trial-container">
          <h2>实验结束！</h2>
          <p>感谢您的参与！您的实验数据已保存。</p>
          <p>文件名: results_${participantId}.csv</p>
          <div class="center-content" style="margin-top: 20px;">
            <button class="jspsych-btn" onclick="returnToIntro()">返回首页</button>
          </div>
        </div>
      `;
    }
  });
}

// 更新进度条
function updateProgressBar() {
  if (totalTrials > 0) {
    const progress = (completedTrials / totalTrials) * 100;
    document.getElementById("progress-bar").style.width = `${progress}%`;
  }
}

// 返回初始界面
function returnToIntro() {
  document.getElementById("jspsych-target").style.display = "none";
  document.getElementById("progress-container").style.display = "none";
  document.getElementById("intro").style.display = "block";
  document.getElementById("participantName").value = "";
  document.getElementById("participantId").value = "";
  participantId = null;
  participantName = null;
  allMaterials = [];
}

// 重置实验
function resetExperiment() {
  const currentId = document.getElementById("participantId").value.trim();
  if (currentId && confirm(`确定要重置编号为 ${currentId} 的实验数据吗？`)) {
    localStorage.removeItem("exp_done_" + currentId);
    localStorage.removeItem(`completedTrials_${currentId}`);
    alert("实验已重置，可以重新开始");
  } else if (!currentId) {
    alert("请先输入要重置的编号");
  }
}

// ========== 材料加载 ==========
async function loadMaterials(){
  try {
    // 使用模拟数据，避免网络请求问题
    const mockMaterials = [
      {
        audio: "https://example.com/audio1.mp3",
        type: "practice",
        q1: "这个音频的语气是？",
        q2: "这个音频的适合程度如何？",
        q3: "这个音频让你感到愉快吗？",
        q4: "这个音频让你感到激动吗？",
        q5: "这个音频给你多大的掌控感？"
      },
      {
        audio: "https://example.com/audio2.mp3",
        type: "formal",
        q1: "这个音频的语气是？",
        q2: "这个音频的适合程度如何？",
        q3: "这个音频让你感到愉快吗？",
        q4: "这个音频让你感到激动吗？",
        q5: "这个音频给你多大的掌控感？"
      }
    ];
    
    // 在实际应用中，您应该取消注释下面的代码，并替换为您的材料URL
    /*
    let response = await fetch("https://gigibon.github.io/Warn_name_audio/materials.csv");
    if (!response.ok) {
      throw new Error(`网络响应不正常: ${response.status}`);
    }
    let text = await response.text();
    let parsed = Papa.parse(text, { header: true, skipEmptyLines: true });

    const requiredFields = ['audio','type','q1','q2','q3','q4','q5'];
    parsed.data.forEach((row,i)=>{
      requiredFields.forEach(f=>{
        if(!row[f]) throw new Error(`实验材料不完整，第 ${i+2} 行缺少 ${f}`);
      });
    });
    */
    
    // 返回模拟数据
    return mockMaterials;
    
    // 在实际应用中，返回解析后的数据
    // return parsed.data;
  } catch (error) {
    console.error("加载材料失败:", error);
    throw new Error(`无法加载实验材料: ${error.message}`);
  }
}

// ========== 生成单个试次 ==========
function createTrial(row) {
  return {
    type: 'html-button-response',
    stimulus: `
      <div class="trial-container">
        <p>请播放并完整听完音频，然后回答以下问题：</p>
        <div class="audio-controls">
          <audio id="trial-audio" src="${row.audio}" controls style="margin: 15px 0; width: 100%;"></audio>
        </div>
        <form id="survey-form">
          <fieldset><legend>${row.q1}</legend>
            <label><input type="radio" name="Q1" value="陈述语气" disabled> 陈述语气</label>
            <label><input type="radio" name="Q1" value="警告语气" disabled> 警告语气</label>
          </fieldset>
          <fieldset><legend>${row.q2}</legend>
            <div style="display:flex; justify-content:space-between;"><span>1=非常不适合</span><span>7=非常适合</span></div>
            ${[1,2,3,4,5,6,7].map(v=>`<label><input type="radio" name="Q2" value="${v}" disabled> ${v}</label>`).join(' ')}
          </fieldset>
          <fieldset><legend>${row.q3}</legend>
            <div style="display:flex; justify-content:space-between;"><span>1=非常不愉快</span><span>7=非常愉快</span></div>
            ${[1,2,3,4,5,6,7].map(v=>`<label><input type="radio" name="Q3" value="${v}" disabled> ${v}</label>`).join(' ')}
          </fieldset>
          <fieldset><legend>${row.q4}</legend>
            <div style="display:flex; justify-content:space-between;"><span>1=非常平静</span><span>7=非常激动</span></div>
            ${[1,2,3,4,5,6,7].map(v=>`<label><input type="radio" name="Q4" value="${v}" disabled> ${v}</label>`).join(' ')}
          </fieldset>
          <fieldset><legend>${row.q5}</legend>
            <div style="display:flex; justify-content:space-between;"><span>1=完全没有掌控感</span><span>7=非常有掌控感</span></div>
            ${[1,2,3,4,5,6,7].map(v=>`<label><input type="radio" name="Q5" value="${v}" disabled> ${v}</label>`).join(' ')}
          </fieldset>
        </form>
      </div>
    `,
    choices: ["提交答案"],
    on_load: function(){
      const audioEl = document.getElementById("trial-audio");
      const btns = document.querySelectorAll("input[type=radio]");
      const submitBtn = document.querySelector(".jspsych-btn");
      submitBtn.disabled = true;
      
      // 确保音频播放完成后才能选择答案
      audioEl.addEventListener("ended", () => {
        btns.forEach(b => b.disabled = false);
        submitBtn.disabled = false;
      });
      
      // 如果用户手动暂停后又播放，确保状态正确
      audioEl.addEventListener("play", () => {
        if (audioEl.ended) {
          btns.forEach(b => b.disabled = false);
          submitBtn.disabled = false;
        }
      });
    },
    on_finish: function(data){
      let formData = {};
      const form = document.getElementById("survey-form");
      if (form) {
        new FormData(form).forEach((val,key)=>{formData[key]=val;});
      }
      
      data.responses = formData;
      data.phase = row.type;
      data.audio_filename = row.audio.split('/').pop();

      const completedKey = `completedTrials_${participantId}`;
      let completed = JSON.parse(localStorage.getItem(completedKey)||"[]");
      if(!completed.includes(row.audio)){
        completed.push(row.audio);
        localStorage.setItem(completedKey, JSON.stringify(completed));
      }
      
      // 更新进度
      completedTrials++;
      updateProgressBar();
    }
  };
}

// ========== 启动实验 ==========
async function startExperiment() {
  participantName = document.getElementById("participantName").value.trim();
  participantId = document.getElementById("participantId").value.trim();

  if (!participantName || !participantId) {
    alert("请输入姓名和编号！");
    return;
  }

  if (localStorage.getItem("exp_done_" + participantId)) {
    if (!confirm("该编号已经完成过实验，继续将覆盖之前的记录。是否继续？")) {
      return;
    }
  }

  document.getElementById("intro").style.display = "none";
  document.getElementById("jspsych-target").style.display = "block";
  document.getElementById("progress-container").style.display = "block";

  // 显示加载提示
  document.getElementById("jspsych-target").innerHTML = `
    <div class="loading">
      <div class="spinner"></div>
      <p>正在加载实验材料，请稍候...</p>
    </div>
  `;

  try {
    allMaterials = await loadMaterials();
  } catch (error) {
    document.getElementById("jspsych-target").innerHTML = `
      <div class="error-message">
        <h3>加载实验材料出错</h3>
        <p>${error.message}</p>
        <p>请检查网络连接后重试，或联系实验负责人。</p>
        <div class="center-content" style="margin-top: 20px;">
          <button class="jspsych-btn" onclick="returnToIntro()">返回首页</button>
        </div>
      </div>
    `;
    console.error("材料加载错误:", error);
    return;
  }

  if (allMaterials.length === 0) {
    document.getElementById("jspsych-target").innerHTML = `
      <div class="trial-container">
        <h2>已完成所有实验内容</h2>
        <p>您已完成所有实验内容，感谢您的参与！</p>
        <div class="center-content" style="margin-top: 20px;">
          <button class="jspsych-btn" onclick="returnToIntro()">返回首页</button>
        </div>
      </div>
    `;
    return;
  }

  // 初始化jsPsych
  jsPsych = initJsPsych();
  
  // 设置总试次数和进度条
  totalTrials = allMaterials.length;
  completedTrials = 0;
  updateProgressBar();

  // === Timeline 构建 ===
  const timeline = [];

  timeline.push({
    type: 'survey-html-form',
    preamble: "<h2>确认信息</h2>",
    html: `<p><b>姓名:</b> ${participantName}</p><p><b>编号:</b> ${participantId}</p>`,
    button_label: "确认并继续"
  });

  timeline.push({
    type: 'instructions',
    pages: [
      `<div class="instructions">
        <h2>指导语</h2>
        <p>欢迎参加音频感知实验！</p>
        <p>您将听到一系列音频，每次答题时需要完整听完音频，然后作答。</p>
        <p>请根据您的真实感受作答，没有对错之分。</p>
        <p>实验包含练习部分和正式部分，请按照提示进行操作。</p>
        <p>完成整个实验大约需要15-20分钟，请确保在安静的环境中完成实验。</p>
      </div>`
    ],
    show_clickable_nav: true,
    button_label_next: "开始练习",
    button_label_previous: "返回"
  });

  // 练习
  const practiceTrials = allMaterials.filter(m => m.type === "practice").map(r => createTrial(r));
  if(practiceTrials.length > 0){
    timeline.push(...practiceTrials);
    
    // 添加练习结束提示
    timeline.push({
      type: 'instructions',
      pages: [
        `<div class="instructions">
          <h2>练习结束</h2>
          <p>您已完成练习部分，接下来将开始正式实验。</p>
          <p>正式实验的流程与练习部分相同，请继续认真作答。</p>
        </div>`
      ],
      show_clickable_nav: true,
      button_label_next: "开始正式实验"
    });
  }

  // 正式实验
  const formalTrials = allMaterials.filter(m => m.type === "formal").map(r => createTrial(r));
  if(formalTrials.length > 0){
    timeline.push(...formalTrials);
  }

  // 运行实验
  jsPsych.run(timeline);
}
</script>
</body>
</html>