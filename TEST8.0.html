<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>音频前测实验</title>
  <link rel="icon" href="data:,">
  <!-- jsPsych v7 -->
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" />
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: "微软雅黑", "Arial", sans-serif; }
    .jspsych-btn { margin: 5px; padding: 8px 16px; cursor: pointer; }
    .instructions { line-height: 1.6; margin-bottom: 20px; }
    fieldset { border: none; margin: 10px 0; padding: 10px; background-color: #f5f5f5; border-radius: 5px; }
    legend { font-weight: bold; margin-bottom: 5px; }
    input[type=radio][disabled] { cursor: not-allowed; }
    .loading { text-align: center; padding: 20px; }
    .error-message { color: #dc3545; padding: 10px; text-align: center; }
    #intro { max-width: 500px; margin: 50px auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; }
    .form-group { margin-bottom: 15px; }
    label { display: inline-block; margin-right: 15px; }
  </style>
</head>
<body>
  <!-- ====== 被试输入界面 ====== -->
  <div id="intro">
    <h2>实验登录</h2>
    <p>请输入您的姓名和编号后开始：</p>
    <div class="form-group">
      姓名: <input id="participantName" type="text" required>
    </div>
    <div class="form-group">
      编号: <input id="participantId" type="text" required>
    </div>
    <button onclick="startExperiment()">进入实验</button>
    <button onclick="resetExperiment()" style="margin-left:10px;">重置实验</button>
  </div>

  <div id="jspsych-target" style="display:none; max-width: 800px; margin: 0 auto; padding: 20px;"></div>

<script>
let participantId = null;
let participantName = null;
let jsPsych;
let allMaterials = [];
let currentTrialIndex = 0;
let timelineType = 'practice'; // 'practice' 或 'formal'

// 初始化jsPsych - 确保每次试次前清空显示区域
function initJsPsychInstance() {
  return initJsPsych({
    display_element: "jspsych-target",
    on_trial_start: function() {
      // 在每个试次开始前清空显示区域
      document.getElementById("jspsych-target").innerHTML = "";
    },
    on_finish: function() {
      // 标记完成
      localStorage.setItem("exp_done_" + participantId, "true");

      // 保存 CSV
      const data = jsPsych.data.get();
      data.addProperties({
        participant_id: participantId,
        participant_name: participantName,
        experiment_start: new Date(jsPsych.data.get().values()[0]?.time_start || Date.now()).toISOString(),
        experiment_end: new Date().toISOString(),
        duration_seconds: (jsPsych.getTotalTime() / 1000).toFixed(2)
      });
      data.localSave('csv', `results_${participantId}.csv`);
      
      // 实验结束后显示返回初始界面的选项
      document.getElementById("jspsych-target").innerHTML = `
        <h2>实验结束！</h2>
        <p>感谢您的参与！您的实验数据已保存。</p>
        <button class="jspsych-btn" onclick="returnToIntro()">返回首页</button>
      `;
    }
  });
}

// 返回初始界面
function returnToIntro() {
  document.getElementById("jspsych-target").style.display = "none";
  document.getElementById("intro").style.display = "block";
  // 清空输入框和状态变量
  document.getElementById("participantName").value = "";
  document.getElementById("participantId").value = "";
  participantId = null;
  participantName = null;
  allMaterials = [];
  currentTrialIndex = 0;
  timelineType = 'practice';
}

// 重置实验（清除当前用户的完成状态）
function resetExperiment() {
  const currentId = document.getElementById("participantId").value.trim();
  if (currentId && confirm(`确定要重置编号为 ${currentId} 的实验数据吗？`)) {
    localStorage.removeItem("exp_done_" + currentId);
    localStorage.removeItem(`completedTrials_${currentId}`);
    alert("实验已重置，可以重新开始");
  } else if (!currentId) {
    alert("请先输入要重置的编号");
  }
}

// ========== 被试信息表单 ==========
function createInfoForm() {
  // 确保变量已正确设置
  if (!participantName || !participantId) {
    console.error("参与者信息未正确设置");
    return {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<div class="error-message"><h3>错误</h3><p>参与者信息未正确加载，请返回重新输入。</p></div>`,
      choices: ["返回"],
      on_finish: returnToIntro
    };
  }
  
  return {
    type: jsPsychSurveyHtmlForm,
    preamble: "<h2>确认信息</h2><p>以下为您填写的信息：</p>",
    html: `
      <p><b>姓名:</b> ${participantName}</p>
      <p><b>编号:</b> ${participantId}</p>
    `,
    button_label: "确认并继续",
    on_finish: function() {
      // 信息确认后加载指导语
      runTrial(createInstructionsTrial());
    }
  };
}

// ========== 指导语 ==========
function createInstructionsTrial() {
  return {
    type: jsPsychInstructions,
    pages: [
      `<div class="instructions">
        <h2>指导语</h2>
        <p>您将听到一系列音频。</p>
        <p>每次答题时，您需要先完整听完音频，之后才可以作答。</p>
        <p>如果需要，可以再次点击播放按钮重复收听音频。</p>
        <p>请根据您的真实感受作答，答案没有对错之分。</p>
      </div>`
    ],
    show_clickable_nav: true,
    button_label_next: "开始练习",
    button_label_previous: "重新阅读",
    on_finish: function() {
      // 指导语完成后开始第一个练习试次
      startPracticeTrials();
    }
  };
}

// ========== 加载材料 ==========
async function loadMaterials(){
  try {
    // 显示加载状态
    const target = document.getElementById("jspsych-target");
    target.innerHTML = '<div class="loading"><p>正在加载实验材料，请稍候...</p></div>';
    
    // 增加超时处理（10秒）
    const timeoutPromise = new Promise((_, reject) => 
      setTimeout(() => reject(new Error("加载超时，请检查网络连接")), 10000)
    );
    
    // 同时进行fetch和超时检查
    let response = await Promise.race([
      fetch("https://gigibon.github.io/Warn_name_audio/materials.csv"),
      timeoutPromise
    ]);
    
    if(!response.ok) throw new Error(`加载失败，错误代码: ${response.status}`);
    
    let text = await response.text();
    let parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    
    if(parsed.errors.length > 0){
      console.error("CSV 解析错误:", parsed.errors);
      throw new Error("实验材料格式错误");
    }
    
    let data = parsed.data;
    const requiredFields = ['audio','type','q1','q2','q3','q4','q5'];
    data.forEach((row,i) => {
      requiredFields.forEach(f=>{
        if(!row[f]) throw new Error(`实验材料不完整，第 ${i+2} 行缺少必要信息`);
      });
    });
    
    // 获取当前用户已完成的试次
    const completedKey = `completedTrials_${participantId}`;
    let completed = JSON.parse(localStorage.getItem(completedKey)||"[]");
    const remaining = data.filter(r => !completed.includes(r.audio));
    
    return remaining;
  } catch (error) {
    console.error("材料加载错误:", error);
    // 显示明确的错误信息
    const errorTrial = { 
      type: jsPsychHtmlButtonResponse, 
      stimulus: `<div class="error-message"><h3>无法加载实验材料</h3><p>错误信息: ${error.message}</p><p>请检查网络连接或稍后再试。</p></div>`,
      choices: ["返回首页"] ,
      on_finish: returnToIntro
    };
    
    // 如果jsPsych已初始化，运行错误试次
    if (jsPsych) {
      jsPsych.run([errorTrial]);
    } else {
      // 如果jsPsych未初始化，直接显示错误
      document.getElementById("jspsych-target").innerHTML = errorTrial.stimulus + 
        '<button class="jspsych-btn" onclick="returnToIntro()">返回首页</button>';
    }
    
    throw error;
  }
}

// ========== 生成试次 ==========
function createTrial(row, isLastTrial = false) {
  return {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <p>请播放并完整听完音频，然后回答以下问题：</p>
      <audio id="trial-audio" src="${row.audio}" controls style="margin: 15px 0; width: 100%;"></audio>
      <form id="survey-form">
        <fieldset>
          <legend>${row.q1}</legend>
          <label><input type="radio" name="Q1" value="陈述语气" disabled> 陈述语气</label>
          <label><input type="radio" name="Q1" value="警告语气" disabled> 警告语气</label>
        </fieldset>
        <fieldset>
          <legend>${row.q2}</legend>
          <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
            <span>1=非常不适合</span><span>7=非常适合</span>
          </div>
          ${[1,2,3,4,5,6,7].map(v=>`<label><input type="radio" name="Q2" value="${v}" disabled> ${v}</label>`).join(' ')}
        </fieldset>
        <fieldset>
          <legend>${row.q3}</legend>
          <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
            <span>1=非常不愉快</span><span>7=非常愉快</span>
          </div>
          ${[1,2,3,4,5,6,7].map(v=>`<label><input type="radio" name="Q3" value="${v}" disabled> ${v}</label>`).join(' ')}
        </fieldset>
        <fieldset>
          <legend>${row.q4}</legend>
          <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
            <span>1=非常平静</span><span>7=非常激动</span>
          </div>
          ${[1,2,3,4,5,6,7].map(v=>`<label><input type="radio" name="Q4" value="${v}" disabled> ${v}</label>`).join(' ')}
        </fieldset>
        <fieldset>
          <legend>${row.q5}</legend>
          <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
            <span>1=完全没有掌控感</span><span>7=非常有掌控感</span>
          </div>
          ${[1,2,3,4,5,6,7].map(v=>`<label><input type="radio" name="Q5" value="${v}" disabled> ${v}</label>`).join(' ')}
        </fieldset>
      </form>
    `,
    choices: ["提交答案"],
    on_load: function(){
      const audioEl = document.getElementById("trial-audio");
      const btns = document.querySelectorAll("input[type=radio]");
      const submitBtn = document.querySelector(".jspsych-btn");
      submitBtn.disabled = true;
      
      // 音频播放结束后启用选项
      audioEl.addEventListener("ended", () => {
        btns.forEach(b=>b.disabled=false);
        submitBtn.disabled = false;
      });
      
      // 如果用户手动暂停后又播放到结束，也应该启用选项
      audioEl.addEventListener("timeupdate", () => {
        if (audioEl.ended) {
          btns.forEach(b=>b.disabled=false);
          submitBtn.disabled = false;
        }
      });
    },
    on_finish: function(data){
      let formData = {};
      new FormData(document.getElementById("survey-form")).forEach((val,key)=>{formData[key]=val;});
      data.responses = formData;
      data.phase = row.type;
      data.audio_filename = row.audio.split('/').pop();
      
      // 保存当前用户已完成的试次
      const completedKey = `completedTrials_${participantId}`;
      let completed = JSON.parse(localStorage.getItem(completedKey)||"[]");
      if(!completed.includes(row.audio)){
        completed.push(row.audio);
        localStorage.setItem(completedKey, JSON.stringify(completed));
      }
      
      // 加载下一个试次或结束
      if (!isLastTrial) {
        if (timelineType === 'practice') {
          currentTrialIndex++;
          startPracticeTrials();
        } else {
          currentTrialIndex++;
          startFormalTrials();
        }
      } else {
        if (timelineType === 'practice') {
          showPracticeCompletion();
        } else {
          jsPsych.finishExperiment();
        }
      }
    }
  };
}

// 运行单个试次
function runTrial(trial) {
  try {
    // 清空当前内容
    document.getElementById("jspsych-target").innerHTML = "";
    // 运行单个试次
    jsPsych.run([trial]);
  } catch (error) {
    console.error("运行试次时出错:", error);
    document.getElementById("jspsych-target").innerHTML = `
      <div class="error-message">
        <h3>试次加载错误</h3>
        <p>无法加载当前试次，请返回重试。</p>
      </div>
      <button class="jspsych-btn" onclick="returnToIntro()">返回首页</button>
    `;
  }
}

// ========== 练习部分 ==========
function startPracticeTrials() {
  try {
    const practiceMaterials = allMaterials.filter(m => m.type === "practice");
    
    if (currentTrialIndex < practiceMaterials.length) {
      const isLastTrial = currentTrialIndex === practiceMaterials.length - 1;
      runTrial(createTrial(practiceMaterials[currentTrialIndex], isLastTrial));
    } else {
      showPracticeCompletion();
    }
  } catch (error) {
    console.error("练习试次错误:", error);
    runTrial({
      type: jsPsychHtmlButtonResponse,
      stimulus: `<div class="error-message"><h3>错误</h3><p>无法加载练习试次。</p></div>`,
      choices: ["返回首页"],
      on_finish: returnToIntro
    });
  }
}

// 练习完成后的选择界面
function showPracticeCompletion() {
  runTrial({
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p>练习结束。请选择操作：</p>",
    choices: ["重新练习", "进入正式实验"],
    on_finish: function(d) {
      if (d.response === 0) { // 重新练习
        const completedKey = `completedTrials_${participantId}`;
        let completed = JSON.parse(localStorage.getItem(completedKey) || "[]");
        const practiceMaterials = allMaterials.filter(m => m.type === "practice");
        completed = completed.filter(item => !practiceMaterials.some(p => p.audio === item));
        localStorage.setItem(completedKey, JSON.stringify(completed));
        
        currentTrialIndex = 0;
        startPracticeTrials();
      } else { // 进入正式实验
        timelineType = 'formal';
        currentTrialIndex = 0;
        startFormalTrials();
      }
    }
  });
}

// ========== 正式部分 ==========
function startFormalTrials() {
  try {
    const formalMaterials = jsPsych.randomization.shuffle(allMaterials.filter(m => m.type === "formal"));
    
    if (currentTrialIndex < formalMaterials.length) {
      const isLastTrial = currentTrialIndex === formalMaterials.length - 1;
      runTrial(createTrial(formalMaterials[currentTrialIndex], isLastTrial));
    } else {
      jsPsych.finishExperiment();
    }
  } catch (error) {
    console.error("正式试次错误:", error);
    runTrial({
      type: jsPsychHtmlButtonResponse,
      stimulus: `<div class="error-message"><h3>错误</h3><p>无法加载正式试次。</p></div>`,
      choices: ["返回首页"],
      on_finish: returnToIntro
    });
  }
}

// ========== 启动实验 ==========
async function startExperiment() {
  try {
    participantName = document.getElementById("participantName").value.trim();
    participantId = document.getElementById("participantId").value.trim();

    if (!participantName || !participantId) {
      alert("请输入姓名和编号！");
      return;
    }
    
    // 检查该编号是否已完成实验
    if (localStorage.getItem("exp_done_" + participantId)) {
      if (!confirm("该编号已经完成过实验，继续将覆盖之前的记录。是否继续？")) {
        return;
      }
    }

    // 隐藏初始界面，显示实验界面
    document.getElementById("intro").style.display = "none";
    const target = document.getElementById("jspsych-target");
    target.style.display = "block";
    target.innerHTML = '<div class="loading"><p>正在初始化实验，请稍候...</p></div>';
    
    // 初始化jsPsych实例
    jsPsych = initJsPsychInstance();

    // 加载所有材料
    allMaterials = await loadMaterials();
    
    if (allMaterials.length === 0) {
      runTrial({
        type: jsPsychHtmlButtonResponse,
        stimulus: "<p>您已完成所有实验内容</p>",
        choices: ["返回首页"],
        on_finish: returnToIntro
      });
    } else {
      // 开始信息确认
      runTrial(createInfoForm());
    }
  } catch (error) {
    console.error("启动实验时出错:", error);
    // 显示错误信息并允许返回
    const target = document.getElementById("jspsych-target");
    target.innerHTML = `
      <div class="error-message">
        <h3>实验启动失败</h3>
        <p>错误信息: ${error.message || "未知错误"}</p>
      </div>
      <button class="jspsych-btn" onclick="returnToIntro()">返回首页</button>
    `;
    target.style.display = "block";
  }
}
</script>
</body>
</html>
    